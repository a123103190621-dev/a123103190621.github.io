<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笨兔子和小熊猫的恋爱记账本</title>
    <style>
        :root {
            --primary-color: #f8bbd0; /* 浅粉色 */
            --secondary-color: #bbdefb; /* 浅蓝色 */
            --accent-color: #64b5f6;
            --text-color: #333;
            --light-text: #666;
            --bg-color: #f5f5f5;
            --card-color: #fff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .drop {
            position: absolute;
            width: 1px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(200, 200, 255, 0.3), rgba(200, 200, 255, 0.1));
            animation: rain linear infinite;
        }

        @keyframes rain {
            to {
                transform: translateY(100vh);
            }
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile {
            display: flex;
            align-items: center;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--secondary-color);
            transition: transform 0.3s;
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .title h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .title input {
            font-size: 1.5rem;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--text-color);
            width: 100%;
            border-bottom: 1px dashed var(--light-text);
            padding: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: var(--card-color);
            border: none;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .ledger-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .ledger-btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 20px;
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .ledger-btn.active {
            background-color: var(--primary-color);
        }

        .balance-display {
            background-color: var(--card-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .balance-display h3 {
            margin-bottom: 10px;
            color: var(--light-text);
        }

        .balance-amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .form-container {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--light-text);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .radio-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-input:checked + .radio-label {
            background-color: var(--primary-color);
            color: white;
        }

        .radio-input {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background-color: #42a5f5;
        }

        .transaction-list {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .transaction-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .transaction-amount {
            font-weight: bold;
        }

        .transaction-amount.income {
            color: #4caf50;
        }

        .transaction-amount.expense {
            color: #f44336;
        }

        .transaction-category {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e0e0e0;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .transaction-account {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .transaction-comment {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            position: relative;
        }

        .comment-author {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .transaction-time {
            font-size: 0.8rem;
            color: var(--light-text);
            margin-top: 5px;
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .filter-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
        }

        .filter-btn.active {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .avatar-upload {
            margin-top: 20px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .title h1 {
                font-size: 1.3rem;
            }
            
            .tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .ledger-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .balance-amount {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="rain" id="rain"></div>
    
    <div class="container">
        <header>
            <div class="profile">
                <img id="user-avatar" src="https://via.placeholder.com/50" alt="头像" class="avatar">
            </div>
        </header>
        
        <div class="title">
            <h1><input type="text" id="ledger-name" value="笨兔子和小熊猫的恋爱记账本"></h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="record">记账</button>
            <button class="tab" data-tab="history">记录</button>
            <button class="tab" data-tab="stats">统计</button>
        </div>
        
        <div class="tab-content active" id="record-tab">
            <div class="ledger-selector">
                <button class="ledger-btn active" data-ledger="love">和凌肖的恋爱小荷包</button>
                <button class="ledger-btn" data-ledger="daily">日常开销</button>
            </div>
            
            <div class="balance-display">
                <h3>当前存款余额</h3>
                <div class="balance-amount" id="current-balance">¥0.00</div>
            </div>
            
            <div class="form-container">
                <div class="form-group">
                    <label for="transaction-type">类型</label>
                    <select id="transaction-type" class="form-control">
                        <option value="deposit">存钱</option>
                        <option value="expense">花钱</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="account-type">账户</label>
                    <select id="account-type" class="form-control">
                        <option value="微信">微信</option>
                        <option value="支付宝">支付宝</option>
                        <option value="银行卡">银行卡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amount">金额</label>
                    <input type="number" id="amount" class="form-control" placeholder="输入金额">
                </div>
                
                <div class="form-group" id="category-group">
                    <label>分类</label>
                    <div class="radio-group" id="category-options">
                        <input type="radio" name="category" id="category-snack" value="零食" class="radio-input" checked>
                        <label for="category-snack" class="radio-label">零食</label>
                        
                        <input type="radio" name="category" id="category-clothes" value="衣服" class="radio-input">
                        <label for="category-clothes" class="radio-label">衣服</label>
                        
                        <input type="radio" name="category" id="category-transport" value="交通" class="radio-input">
                        <label for="category-transport" class="radio-label">交通</label>
                        
                        <input type="radio" name="category" id="category-travel" value="旅行" class="radio-input">
                        <label for="category-travel" class="radio-label">旅行</label>
                        
                        <input type="radio" name="category" id="category-phone" value="话费网费" class="radio-input">
                        <label for="category-phone" class="radio-label">话费网费</label>
                        
                        <input type="radio" name="category" id="category-study" value="学习" class="radio-input">
                        <label for="category-study" class="radio-label">学习</label>
                        
                        <input type="radio" name="category" id="category-daily" value="日用品" class="radio-input">
                        <label for="category-daily" class="radio-label">日用品</label>
                        
                        <input type="radio" name="category" id="category-beauty" value="美妆" class="radio-input">
                        <label for="category-beauty" class="radio-label">美妆</label>
                        
                        <input type="radio" name="category" id="category-medical" value="医疗" class="radio-input">
                        <label for="category-medical" class="radio-label">医疗</label>
                        
                        <input type="radio" name="category" id="category-entertainment" value="娱乐" class="radio-input">
                        <label for="category-entertainment" class="radio-label">娱乐</label>
                        
                        <input type="radio" name="category" id="category-gifts" value="人情往来" class="radio-input">
                        <label for="category-gifts" class="radio-label">人情往来</label>
                        
                        <input type="radio" name="category" id="category-sports" value="运动" class="radio-input">
                        <label for="category-sports" class="radio-label">运动</label>
                        
                        <input type="radio" name="category" id="category-utilities" value="水电煤" class="radio-input">
                        <label for="category-utilities" class="radio-label">水电煤</label>
                        
                        <input type="radio" name="category" id="category-other" value="其他" class="radio-input">
                        <label for="category-other" class="radio-label">其他</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="note">备注</label>
                    <input type="text" id="note" class="form-control" placeholder="可选备注">
                </div>
                
                <button id="submit-btn" class="btn">记录</button>
            </div>
        </div>
        
        <div class="tab-content" id="history-tab">
            <div class="ledger-selector">
                <button class="ledger-btn active" data-ledger="love">和凌肖的恋爱小荷包</button>
                <button class="ledger-btn" data-ledger="daily">日常开销</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">全部</button>
                <button class="filter-btn" data-filter="week">本周</button>
                <button class="filter-btn" data-filter="month">本月</button>
                <button class="filter-btn" data-filter="year">今年</button>
            </div>
            
            <div class="transaction-list" id="transaction-history">
                <!-- 交易记录将在这里动态生成 -->
                <p style="text-align: center; color: var(--light-text);">暂无记录</p>
            </div>
        </div>
        
        <div class="tab-content" id="stats-tab">
            <div class="ledger-selector">
                <button class="ledger-btn active" data-ledger="love">和凌肖的恋爱小荷包</button>
                <button class="ledger-btn" data-ledger="daily">日常开销</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">全部</button>
                <button class="filter-btn" data-filter="week">本周</button>
                <button class="filter-btn" data-filter="month">本月</button>
                <button class="filter-btn" data-filter="year">今年</button>
            </div>
            
            <div class="balance-display">
                <h3>总存款</h3>
                <div class="balance-amount" id="total-deposit">¥0.00</div>
            </div>
            
            <div class="balance-display">
                <h3>总支出</h3>
                <div class="balance-amount" id="total-expense">¥0.00</div>
            </div>
            
            <div class="balance-display">
                <h3>当前余额</h3>
                <div class="balance-amount" id="stats-balance">¥0.00</div>
            </div>
            
            <div id="category-stats" style="background-color: var(--card-color); padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: var(--shadow);">
                <h3 style="margin-bottom: 15px; text-align: center;">支出分类统计</h3>
                <div id="category-chart">
                    <p style="text-align: center; color: var(--light-text);">暂无支出数据</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 头像上传模态框 -->
    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>更换头像</h3>
            <img id="avatar-preview" src="https://via.placeholder.com/150" alt="头像预览" style="width: 150px; height: 150px; border-radius: 50%; display: block; margin: 0 auto 20px;">
            <input type="file" id="avatar-upload" accept="image/*" class="form-control">
            <button id="save-avatar-btn" class="btn" style="margin-top: 15px;">保存</button>
        </div>
    </div>
    
    <!-- 修改名称模态框 -->
    <div class="modal" id="name-modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>修改昵称</h3>
            <div class="form-group">
                <label for="partner-name">凌肖的昵称</label>
                <input type="text" id="partner-name" class="form-control" value="凌肖">
            </div>
            <div class="form-group">
                <label for="user-name">你的昵称</label>
                <input type="text" id="user-name" class="form-control" value="笨兔子">
            </div>
            <button id="save-name-btn" class="btn" style="margin-top: 15px;">保存</button>
        </div>
    </div>
    
    <script>
        // 凌肖的留言
        const lingXiaoComments = {
            deposit: [
                "看来我们的旅游资金又增加了。",
                "存钱可以，别饿着肚子。",
                "又加班了？不如存点时间陪我。",
                "我们的未来基金+1",
                "去吃火锅怎么样？我现在去找你。",
                "要不要来live house看我演出？",
                "行，下次带你去吃好吃的。",
                "积少成多，这么着急干什么，我来找你了。",
                "笨兔子理财能力见长啊。",
                "啧，看来要准备个更大的存钱罐了。",
                "啧，别累着自己，晚上我去接你。",
                "可以啊，这么能干。",
                "livehouse第一排的位置给你留着呢，大制作人什么时候赏脸？",
                "假期想去哪儿玩？反正和你一起，去哪儿都可以。",
                "走，带你吃顿好的。"
            ],
            expense: {
                零食: [
                    "又背着我吃独食？",
                    "啧，怎么不带我一起？",
                    "独乐乐不如众乐乐，分我一点。",
                    "下次给我买零食就够了，adam他们不要。",
                    "就这么点？够你塞牙缝？",
                    "你是不是又背着我偷吃了？"
                ],
                衣服: [
                    "买新衣服了？怎么不带我去。",
                    "眼光不错，果然和我呆久了笨兔子的审美都提升了不少。",
                    "买这么多新衣服，什么时候和我出来逛逛？",
                    "情侣装啊，我考虑一下"
                ],
                交通: [
                    "去哪儿了？怎么不叫我一起？",
                    "啧，这么远？下次我送你。",
                    "Adam他们问你什么时候来live house",
                    "到家了？我来找你了。",
                    "下次滑滑板带你。"
                ],
                旅行: [
                    "怎么不带我？",
                    "玩得开心吗，笨兔子。",
                    "啧，照片发我看看。",
                    "下次我们一起去。",
                    "想我了没？"
                ],
                话费网费: [
                    "跟谁聊这么久？",
                    "知道了。"
                ],
                学习: [
                    "啧，品学兼优这四个字懂吗？就是专门形容我的。",
                    "啧，别读傻了。",
                    "行，学习是好事。",
                    "看不懂的来问我。"
                ],
                日用品: [
                    "买的什么？我看看。",
                    "嗯，这些是该买了。",
                    "还缺什么，列个单子给我。"
                ],
                美妆: [
                    "看我干什么？我现在可分得清口红色号了。",
                    "这是什么？",
                    "上次的那个口红比较好吃。",
                    "这些瓶瓶罐罐的看着就头晕。",
                    "让我看看买了什么新东西。"
                ],
                医疗: [
                    "生病了？怎么不告诉我。",
                    "啧，笨兔子，会不会照顾自己。",
                    "哪不舒服？我现在过去。",
                    "我现在过去。"
                ],
                娱乐: [
                    "去看live了？哪个乐队？",
                    "打游戏吗？一起。",
                    "上线怎么不喊我。",
                    "明天陪我去碗池滑两圈。",
                    "这周日live house的演出——你会来的吧。",
                    "下个假期，我先预定了。",
                    "不喊我一起？",
                    "他们技术哪有我高。"
                ],
                人情往来: [
                    "什么人情？",
                    "嗯，知道了。"
                ],
                运动: [
                    "去运动了？真是难得。",
                    "不如陪我去滑滑板，保你能吃好睡好",
                    "怎么不喊我一起？",
                    "哟，太阳打西边出来了。",
                    "开门，我带了烧烤。",
                    "减什么肥啊，你哪儿胖了？"
                ],
                水电煤: [
                    "生活费。",
                    "知道了。",
                    "嗯。"
                ],
                其他: [
                    "这又是什么？",
                    "给你捏了个兔子。",
                    "？解释一下。",
                    "行吧。",
                    "我看看。",
                    "嗯。"
                ]
            }
        };

        // 全局变量
        let currentLedger = 'love';
        let transactions = [];
        let usedComments = {
            deposit: [],
            expense: {}
        };
        
        // 初始化使用的评论数组
        Object.keys(lingXiaoComments.expense).forEach(category => {
            usedComments.expense[category] = [];
        });

        // DOM元素
        const userAvatar = document.getElementById('user-avatar');
        const avatarModal = document.getElementById('avatar-modal');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarUpload = document.getElementById('avatar-upload');
        const saveAvatarBtn = document.getElementById('save-avatar-btn');
        const closeAvatarModal = document.querySelector('#avatar-modal .close-btn');
        const ledgerNameInput = document.getElementById('ledger-name');
        const nameModal = document.getElementById('name-modal');
        const partnerNameInput = document.getElementById('partner-name');
        const userNameInput = document.getElementById('user-name');
        const saveNameBtn = document.getElementById('save-name-btn');
        const closeNameModal = document.querySelector('#name-modal .close-btn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const ledgerBtns = document.querySelectorAll('.ledger-btn');
        const transactionType = document.getElementById('transaction-type');
        const categoryGroup = document.getElementById('category-group');
        const amountInput = document.getElementById('amount');
        const noteInput = document.getElementById('note');
        const submitBtn = document.getElementById('submit-btn');
        const currentBalanceDisplay = document.getElementById('current-balance');
        const transactionHistory = document.getElementById('transaction-history');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const totalDepositDisplay = document.getElementById('total-deposit');
        const totalExpenseDisplay = document.getElementById('total-expense');
        const statsBalanceDisplay = document.getElementById('stats-balance');
        const categoryChart = document.getElementById('category-chart');

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            createRain();
            loadData();
            updateBalance();
            renderTransactions();
            updateStats();
            
            // 初始化账本名称
            const savedLedgerName = localStorage.getItem('ledgerName');
            if (savedLedgerName) {
                ledgerNameInput.value = savedLedgerName;
            }
            
            // 初始化昵称
            const savedPartnerName = localStorage.getItem('partnerName') || '凌肖';
            const savedUserName = localStorage.getItem('userName') || '笨兔子';
            partnerNameInput.value = savedPartnerName;
            userNameInput.value = savedUserName;
            
            // 初始化头像
            const savedAvatar = localStorage.getItem('userAvatar');
            if (savedAvatar) {
                userAvatar.src = savedAvatar;
                avatarPreview.src = savedAvatar;
            }
        });

        // 创建雨滴效果
        function createRain() {
            const rainContainer = document.getElementById('rain');
            for (let i = 0; i < 50; i++) {
                const drop = document.createElement('div');
                drop.className = 'drop';
                drop.style.left = Math.random() * 100 + 'vw';
                drop.style.top = Math.random() * -100 + 'vh';
                drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                drop.style.animationDelay = Math.random() * 2 + 's';
                drop.style.opacity = Math.random() * 0.5 + 0.3;
                rainContainer.appendChild(drop);
            }
        }

        // 加载数据
        function loadData() {
            const savedTransactions = localStorage.getItem('transactions');
            if (savedTransactions) {
                transactions = JSON.parse(savedTransactions);
            }
            
            const savedUsedComments = localStorage.getItem('usedComments');
            if (savedUsedComments) {
                usedComments = JSON.parse(savedUsedComments);
            }
        }

        // 保存数据
        function saveData() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('usedComments', JSON.stringify(usedComments));
        }

        // 更新余额显示
        function updateBalance() {
            const ledgerTransactions = transactions.filter(t => t.ledger === currentLedger);
            const balance = ledgerTransactions.reduce((total, t) => {
                return t.type === 'deposit' ? total + t.amount : total - t.amount;
            }, 0);
            
            currentBalanceDisplay.textContent = `¥${balance.toFixed(2)}`;
        }

        // 渲染交易记录
        function renderTransactions(filter = 'all') {
            let ledgerTransactions = transactions.filter(t => t.ledger === currentLedger);
            
            // 应用时间筛选
            if (filter !== 'all') {
                const now = new Date();
                let startDate;
                
                if (filter === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                } else if (filter === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (filter === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                ledgerTransactions = ledgerTransactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= startDate;
                });
            }
            
            if (ledgerTransactions.length === 0) {
                transactionHistory.innerHTML = '<p style="text-align: center; color: var(--light-text);">暂无记录</p>';
                return;
            }
            
            // 按时间降序排序
            ledgerTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            transactionHistory.innerHTML = '';
            
            ledgerTransactions.forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                const transactionHeader = document.createElement('div');
                transactionHeader.className = 'transaction-header';
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'transaction-category';
                categorySpan.textContent = transaction.category || '存款';
                
                const accountSpan = document.createElement('span');
                accountSpan.className = 'transaction-account';
                accountSpan.textContent = transaction.account;
                
                const amountSpan = document.createElement('span');
                amountSpan.className = `transaction-amount ${transaction.type}`;
                amountSpan.textContent = transaction.type === 'deposit' ? `+¥${transaction.amount.toFixed(2)}` : `-¥${transaction.amount.toFixed(2)}`;
                
                transactionHeader.appendChild(categorySpan);
                transactionHeader.appendChild(accountSpan);
                transactionHeader.appendChild(amountSpan);
                
                const noteDiv = document.createElement('div');
                noteDiv.textContent = transaction.note || '';
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'transaction-time';
                timeDiv.textContent = formatDate(transaction.timestamp);
                
                transactionItem.appendChild(transactionHeader);
                if (transaction.note) transactionItem.appendChild(noteDiv);
                
                if (transaction.comment) {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'transaction-comment';
                    
                    const authorSpan = document.createElement('div');
                    authorSpan.className = 'comment-author';
                    authorSpan.textContent = `${localStorage.getItem('partnerName') || '凌肖'}:`;
                    
                    const commentText = document.createElement('div');
                    commentText.textContent = transaction.comment;
                    
                    commentDiv.appendChild(authorSpan);
                    commentDiv.appendChild(commentText);
                    transactionItem.appendChild(commentDiv);
                }
                
                transactionItem.appendChild(timeDiv);
                
                // 添加删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '删除';
                deleteBtn.addEventListener('click', () => {
                    deleteTransaction(transaction.id);
                });
                transactionItem.appendChild(deleteBtn);
                
                transactionHistory.appendChild(transactionItem);
            });
        }

        // 删除交易
        function deleteTransaction(id) {
            if (confirm('确定要删除这条记录吗？')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                updateBalance();
                renderTransactions();
                updateStats();
            }
        }

        // 更新统计信息
        function updateStats(filter = 'all') {
            let ledgerTransactions = transactions.filter(t => t.ledger === currentLedger);
            
            // 应用时间筛选
            if (filter !== 'all') {
                const now = new Date();
                let startDate;
                
                if (filter === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                } else if (filter === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (filter === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                ledgerTransactions = ledgerTransactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    return transactionDate >= startDate;
                });
            }
            
            const deposits = ledgerTransactions.filter(t => t.type === 'deposit');
            const expenses = ledgerTransactions.filter(t => t.type === 'expense');
            
            const totalDeposit = deposits.reduce((total, t) => total + t.amount, 0);
            const totalExpense = expenses.reduce((total, t) => total + t.amount, 0);
            const balance = totalDeposit - totalExpense;
            
            totalDepositDisplay.textContent = `¥${totalDeposit.toFixed(2)}`;
            totalExpenseDisplay.textContent = `¥${totalExpense.toFixed(2)}`;
            statsBalanceDisplay.textContent = `¥${balance.toFixed(2)}`;
            
            // 更新分类统计
            updateCategoryStats(expenses);
        }

        // 更新分类统计
        function updateCategoryStats(expenses) {
            if (expenses.length === 0) {
                categoryChart.innerHTML = '<p style="text-align: center; color: var(--light-text);">暂无支出数据</p>';
                return;
            }
            
            // 按分类统计
            const categoryStats = {};
            expenses.forEach(expense => {
                if (!categoryStats[expense.category]) {
                    categoryStats[expense.category] = 0;
                }
                categoryStats[expense.category] += expense.amount;
            });
            
            // 转换为数组并排序
            const sortedCategories = Object.entries(categoryStats)
                .map(([category, amount]) => ({ category, amount }))
                .sort((a, b) => b.amount - a.amount);
            
            // 渲染统计图表
            categoryChart.innerHTML = '';
            
            sortedCategories.forEach(item => {
                const categoryItem = document.createElement('div');
                categoryItem.style.marginBottom = '10px';
                
                const categoryName = document.createElement('div');
                categoryName.style.display = 'flex';
                categoryName.style.justifyContent = 'space-between';
                categoryName.style.marginBottom = '5px';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.category;
                
                const amountSpan = document.createElement('span');
                amountSpan.textContent = `¥${item.amount.toFixed(2)}`;
                
                categoryName.appendChild(nameSpan);
                categoryName.appendChild(amountSpan);
                
                const progressBar = document.createElement('div');
                progressBar.style.height = '10px';
                progressBar.style.backgroundColor = '#e0e0e0';
                progressBar.style.borderRadius = '5px';
                progressBar.style.overflow = 'hidden';
                
                const progressFill = document.createElement('div');
                progressFill.style.height = '100%';
                progressFill.style.width = `${(item.amount / sortedCategories[0].amount) * 100}%`;
                progressFill.style.backgroundColor = getCategoryColor(item.category);
                
                progressBar.appendChild(progressFill);
                
                categoryItem.appendChild(categoryName);
                categoryItem.appendChild(progressBar);
                
                categoryChart.appendChild(categoryItem);
            });
        }

        // 获取分类颜色
        function getCategoryColor(category) {
            const colors = {
                '零食': '#FF9AA2',
                '衣服': '#FFB7B2',
                '交通': '#FFDAC1',
                '旅行': '#E2F0CB',
                '话费网费': '#B5EAD7',
                '学习': '#C7CEEA',
                '日用品': '#F8C8DC',
                '美妆': '#D4A5A5',
                '医疗': '#92C9B1',
                '娱乐': '#A2D2FF',
                '人情往来': '#CDB4DB',
                '运动': '#FFC8DD',
                '水电煤': '#BDE0FE',
                '其他': '#A5A5A5'
            };
            
            return colors[category] || '#A5A5A5';
        }

        // 格式化日期
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return `${date.getFullYear()}-${padZero(date.getMonth() + 1)}-${padZero(date.getDate())} ${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
        }

        // 补零
        function padZero(num) {
            return num < 10 ? `0${num}` : num;
        }

        // 获取随机评论
        function getRandomComment(type, category = null) {
            let comments = [];
            
            if (type === 'deposit') {
                comments = lingXiaoComments.deposit.filter(c => !usedComments.deposit.includes(c));
                
                if (comments.length === 0) {
                    // 如果所有评论都用过了，重置
                    usedComments.deposit = [];
                    comments = lingXiaoComments.deposit;
                }
            } else if (type === 'expense' && category) {
                comments = lingXiaoComments.expense[category].filter(c => !usedComments.expense[category].includes(c));
                
                if (comments.length === 0) {
                    // 如果所有评论都用过了，重置
                    usedComments.expense[category] = [];
                    comments = lingXiaoComments.expense[category];
                }
            }
            
            if (comments.length === 0) return null;
            
            const randomIndex = Math.floor(Math.random() * comments.length);
            const selectedComment = comments[randomIndex];
            
            // 添加到已使用评论
            if (type === 'deposit') {
                usedComments.deposit.push(selectedComment);
            } else if (type === 'expense' && category) {
                usedComments.expense[category].push(selectedComment);
            }
            
            return selectedComment;
        }

        // 事件监听器
        userAvatar.addEventListener('click', () => {
            avatarModal.style.display = 'flex';
        });

        closeAvatarModal.addEventListener('click', () => {
            avatarModal.style.display = 'none';
        });

        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    avatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        saveAvatarBtn.addEventListener('click', () => {
            userAvatar.src = avatarPreview.src;
            localStorage.setItem('userAvatar', avatarPreview.src);
            avatarModal.style.display = 'none';
        });

        ledgerNameInput.addEventListener('change', () => {
            localStorage.setItem('ledgerName', ledgerNameInput.value);
        });

        partnerNameInput.addEventListener('click', (e) => {
            e.stopPropagation();
            nameModal.style.display = 'flex';
        });

        userNameInput.addEventListener('click', (e) => {
            e.stopPropagation();
            nameModal.style.display = 'flex';
        });

        closeNameModal.addEventListener('click', () => {
            nameModal.style.display = 'none';
        });

        saveNameBtn.addEventListener('click', () => {
            localStorage.setItem('partnerName', partnerNameInput.value);
            localStorage.setItem('userName', userNameInput.value);
            nameModal.style.display = 'none';
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                
                if (tab.dataset.tab === 'stats') {
                    updateStats();
                }
            });
        });

        ledgerBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                ledgerBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentLedger = btn.dataset.ledger;
                updateBalance();
                renderTransactions();
                
                // 获取当前激活的筛选按钮
                const activeFilter = document.querySelector('.filter-buttons .filter-btn.active');
                if (activeFilter) {
                    updateStats(activeFilter.dataset.filter);
                }
            });
        });

        transactionType.addEventListener('change', () => {
            if (transactionType.value === 'deposit') {
                categoryGroup.style.display = 'none';
            } else {
                categoryGroup.style.display = 'block';
            }
        });

        submitBtn.addEventListener('click', () => {
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效的金额');
                return;
            }
            
            const type = transactionType.value;
            const account = document.getElementById('account-type').value;
            const note = noteInput.value;
            let category = null;
            let comment = null;
            
            if (type === 'expense') {
                const selectedCategory = document.querySelector('input[name="category"]:checked');
                if (selectedCategory) {
                    category = selectedCategory.value;
                    comment = getRandomComment(type, category);
                }
            } else {
                comment = getRandomComment('deposit');
            }
            
            // 根据金额增加吐槽
            if (amount > 200) {
                if (comment) {
                    comment += " 啧，买这么多，你这是把店搬空了？";
                } else {
                    comment = "啧，买这么多，你这是把店搬空了？";
                }
            } else if (amount < 10) {
                const smallAmountComments = ["蚊子腿也是肉。", "啧，晚上去吃顿好的？"];
                const randomSmallComment = smallAmountComments[Math.floor(Math.random() * smallAmountComments.length)];
                
                if (comment) {
                    comment += ` ${randomSmallComment}`;
                } else {
                    comment = randomSmallComment;
                }
            }
            
            const newTransaction = {
                id: Date.now().toString(),
                ledger: currentLedger,
                type,
                amount,
                account,
                category,
                note,
                comment,
                timestamp: new Date().toISOString()
            };
            
            transactions.push(newTransaction);
            saveData();
            
            // 重置表单
            amountInput.value = '';
            noteInput.value = '';
            
            updateBalance();
            renderTransactions();
            updateStats();
        });

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                renderTransactions(btn.dataset.filter);
                
                if (document.querySelector('.tab.active').dataset.tab === 'stats') {
                    updateStats(btn.dataset.filter);
                }
            });
        });

        // 点击模态框外部关闭模态框
        window.addEventListener('click', (e) => {
            if (e.target === avatarModal) {
                avatarModal.style.display = 'none';
            }
            
            if (e.target === nameModal) {
                nameModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>