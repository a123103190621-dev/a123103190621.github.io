<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笨兔子和小熊猫的恋爱记账本</title>
    <style>
        :root {
            --bg-color: #f9f5ff;
            --primary-color: #5d5fef;
            --secondary-color: #ff85a2;
            --accent-color: #7b68ee;
            --text-color: #4a4a6a;
            --light-text: #ffffff;
            --border-color: #e0d6ff;
            --card-bg: #ffffff;
            --shadow: 0 4px 15px rgba(93, 95, 239, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* 雨滴背景效果 */
        .raindrop {
            position: absolute;
            width: 1px;
            height: 15px;
            background: linear-gradient(to bottom, rgba(123, 104, 238, 0.3), transparent);
            animation: rain linear infinite;
            z-index: -1;
        }

        @keyframes rain {
            0% {
                transform: translateY(-100vh);
            }
            100% {
                transform: translateY(100vh);
            }
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            background-color: rgba(249, 245, 255, 0.85);
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 18px;
            font-weight: bold;
            color: var(--secondary-color);
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--secondary-color);
            transition: all 0.3s;
        }

        .avatar:hover {
            transform: scale(1.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--text-color);
        }

        .tab.active {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        .balance-title {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .time-filter {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            background-color: var(--card-bg);
            padding: 8px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .time-filter-btn {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .time-filter-btn.active {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .record-list {
            margin-bottom: 70px;
        }

        .record-item {
            background-color: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            position: relative;
            transition: all 0.3s;
        }

        .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(93, 95, 239, 0.15);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .record-account {
            font-weight: bold;
            color: var(--accent-color);
        }

        .record-amount {
            font-weight: bold;
            font-size: 18px;
        }

        .record-amount.income {
            color: #4caf50;
        }

        .record-amount.expense {
            color: #f44336;
        }

        .record-category {
            display: inline-block;
            padding: 3px 8px;
            background-color: #f0e9ff;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .record-note {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .record-comment {
            background-color: #f8f5ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            position: relative;
            border-left: 3px solid var(--secondary-color);
        }

        .comment-name {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .record-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .add-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(255, 133, 162, 0.4);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s;
            border: none;
        }

        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 133, 162, 0.6);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(93, 95, 239, 0.2);
            position: relative;
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: var(--secondary-color);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: #f8f5ff;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(123, 104, 238, 0.2);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .radio-group {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }

        .radio-option {
            flex: 1;
            text-align: center;
        }

        .radio-option input {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 12px;
            background-color: #f0e9ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option label:hover {
            background-color: #e5d9ff;
        }

        .radio-option input:checked + label {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-item {
            padding: 10px;
            text-align: center;
            background-color: #f0e9ff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .category-item:hover {
            background-color: #e5d9ff;
        }

        .category-item.selected {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 133, 162, 0.4);
        }

        .avatar-modal {
            text-align: center;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: var(--secondary-color);
            transform: scale(1.1);
        }

        .upload-container {
            margin: 20px 0;
        }

        .upload-btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #f0e9ff;
            color: var(--accent-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px dashed var(--accent-color);
            text-align: center;
        }

        .upload-btn:hover {
            background-color: #e5d9ff;
        }

        #avatar-upload {
            display: none;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ccc;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            color: var(--secondary-color);
            transform: scale(1.2);
        }

        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #aaa;
        }

        .edit-name {
            position: absolute;
            top: 10px;
            right: 35px;
            color: #ccc;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .edit-name:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        @media (min-width: 768px) {
            .container {
                max-width: 450px;
            }
        }
    </style>
</head>
<body>
    <!-- 雨滴背景效果 -->
    <div id="rain-container"></div>

    <div class="container">
        <header>
            <div class="logo">笨兔子和小熊猫的恋爱记账本</div>
            <img src="https://i.imgur.com/JqYeYn7.jpg" alt="小熊猫" class="avatar" id="avatar">
        </header>

        <div class="tabs">
            <div class="tab active" id="tab-love">恋爱小金库</div>
            <div class="tab" id="tab-daily">日常开销</div>
        </div>

        <div class="balance-card" id="balance-card">
            <div class="balance-title" id="balance-title">恋爱基金余额</div>
            <div class="balance-amount" id="balance-amount">¥0.00</div>
        </div>

        <div class="time-filter">
            <div class="time-filter-btn active" data-period="all">全部</div>
            <div class="time-filter-btn" data-period="week">本周</div>
            <div class="time-filter-btn" data-period="month">本月</div>
            <div class="time-filter-btn" data-period="year">今年</div>
        </div>

        <div class="record-list" id="record-list">
            <div class="empty-state">暂无记录，点击右下角按钮添加</div>
        </div>

        <button class="add-btn" id="add-btn">+</button>
    </div>

    <!-- 添加记录模态框 -->
    <div class="modal" id="record-modal">
        <div class="modal-content">
            <span class="close-btn" id="close-modal">&times;</span>
            <h3 id="modal-title">添加存款</h3>
            
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="record-type" id="income" value="income" checked>
                    <label for="income" id="income-label">存钱</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="record-type" id="expense" value="expense">
                    <label for="expense" id="expense-label">花钱</label>
                </div>
            </div>

            <div class="form-group">
                <label for="amount">金额</label>
                <input type="number" id="amount" placeholder="输入金额">
            </div>

            <div class="form-group">
                <label for="account">账户</label>
                <select id="account">
                    <option value="微信">微信</option>
                    <option value="支付宝">支付宝</option>
                    <option value="银行卡">银行卡</option>
                </select>
            </div>

            <div class="form-group" id="category-group">
                <label>分类</label>
                <div class="category-grid" id="category-grid">
                    <!-- 分类选项将通过JS动态生成 -->
                </div>
            </div>

            <div class="form-group">
                <label for="note">备注</label>
                <textarea id="note" placeholder="添加备注（可选）"></textarea>
            </div>

            <button class="submit-btn" id="submit-record">确认</button>
        </div>
    </div>

    <!-- 头像选择模态框 -->
    <div class="modal" id="avatar-modal">
        <div class="modal-content avatar-modal">
            <span class="close-btn" id="close-avatar-modal">&times;</span>
            <h3>选择头像</h3>
            <div class="avatar-options" id="avatar-options">
                <img src="https://i.imgur.com/JqYeYn7.jpg" alt="头像1" class="avatar-option selected" data-src="https://i.imgur.com/JqYeYn7.jpg">
                <img src="https://i.imgur.com/8Km9tLL.jpg" alt="头像2" class="avatar-option" data-src="https://i.imgur.com/8Km9tLL.jpg">
                <img src="https://i.imgur.com/nlhLi3I.jpg" alt="头像3" class="avatar-option" data-src="https://i.imgur.com/nlhLi3I.jpg">
                <img src="https://i.imgur.com/QB6T1nQ.jpg" alt="头像4" class="avatar-option" data-src="https://i.imgur.com/QB6T1nQ.jpg">
                <img src="https://i.imgur.com/Z5ouR7d.jpg" alt="头像5" class="avatar-option" data-src="https://i.imgur.com/Z5ouR7d.jpg">
                <img src="https://i.imgur.com/7vQD0fP.jpg" alt="头像6" class="avatar-option" data-src="https://i.imgur.com/7vQD0fP.jpg">
            </div>
            
            <div class="upload-container">
                <label for="avatar-upload" class="upload-btn">上传自定义头像</label>
                <input type="file" id="avatar-upload" accept="image/*">
            </div>
            
            <button class="submit-btn" id="confirm-avatar">确认</button>
        </div>
    </div>

    <script>
        // 初始化数据
        let records = JSON.parse(localStorage.getItem('lingxiao-account-records')) || [];
        let currentTab = 'love';
        let currentPeriod = 'all';
        let currentAvatar = localStorage.getItem('lingxiao-avatar') || 'https://i.imgur.com/JqYeYn7.jpg';
        let ledgerName = {
            love: localStorage.getItem('lingxiao-ledger-name-love') || '恋爱小金库',
            daily: localStorage.getItem('lingxiao-ledger-name-daily') || '日常开销'
        };
        let commentName = localStorage.getItem('lingxiao-comment-name') || '小熊猫';

        // DOM元素
        const tabLove = document.getElementById('tab-love');
        const tabDaily = document.getElementById('tab-daily');
        const balanceTitle = document.getElementById('balance-title');
        const balanceAmount = document.getElementById('balance-amount');
        const balanceCard = document.getElementById('balance-card');
        const recordList = document.getElementById('record-list');
        const addBtn = document.getElementById('add-btn');
        const recordModal = document.getElementById('record-modal');
        const closeModal = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const incomeRadio = document.getElementById('income');
        const expenseRadio = document.getElementById('expense');
        const incomeLabel = document.getElementById('income-label');
        const expenseLabel = document.getElementById('expense-label');
        const amountInput = document.getElementById('amount');
        const accountSelect = document.getElementById('account');
        const categoryGroup = document.getElementById('category-group');
        const categoryGrid = document.getElementById('category-grid');
        const noteTextarea = document.getElementById('note');
        const submitRecord = document.getElementById('submit-record');
        const avatar = document.getElementById('avatar');
        const avatarModal = document.getElementById('avatar-modal');
        const closeAvatarModal = document.getElementById('close-avatar-modal');
        const avatarOptions = document.getElementById('avatar-options');
        const confirmAvatar = document.getElementById('confirm-avatar');
        const timeFilterBtns = document.querySelectorAll('.time-filter-btn');
        const avatarUpload = document.getElementById('avatar-upload');
        const rainContainer = document.getElementById('rain-container');

        // 分类选项
        const categories = {
            love: ['存款'],
            daily: ['零食', '衣服', '交通', '旅行', '话费网费', '学习', '日用品', '美妆', '医疗', '娱乐', '人情往来', '运动', '水电煤', '其他']
        };

        // 小熊猫的评论库
        const comments = {
            deposit: [
                "看来我们的旅行基金又增加了。",
                "下个假期想去哪里玩？",
                "啧，怎么又加班？",
                "要不要live house看演出？",
                "啧，别太辛苦",
                "存钱可以，别饿着自己",
                "我们的未来基金+1",
                "存这么多？晚上我请你吃火锅。",
                "行啊，你忙完了带你去吃好吃的",
                "怎么又加班？",
                "啧，看来今晚的宵夜我请。"
                "看来笨兔子的理财能力见长啊。",
                "啧，怎么感觉你又瘦了？走，带你去吃火锅。"
               "啧，看来我得准备个更大的存钱罐了",
               "啧，别太累着自己"
           ],
            daily: {
                '零食': [
                    "啧，又买零食？",
                    "吃不完还不是要给我。",
                    "减什么肥啊，人生还是快乐最重要。",
                    "又背着我吃独食？",
                    "啧，胖了可别怪我没提醒你。",
                    "独乐乐不如众乐乐，我来找你了。",
                    "下次不用给Adam他们带了，他们减肥。",
                    "少吃点，晚上带你去吃好的",
                    "啧，家里的可乐是不是要没了？"
               ],
                '衣服': [
                    "啧，又买衣服？怎么不喊我给你参谋参谋？",
                    "我的审美你不放心？",
                    "情侣装啊……我又没说不穿。",
                    "买这么多新衣服，什么时候和我出去玩？",
                    "衣品不错，果然和我呆久了就连笨兔子的审美都提升了。"
                ],
                '交通': [
                    "去哪了？怎么不叫我一起？",
                    "下次滑滑板带你。",
                    "下次我去接你"
               ],
                '旅行': [
                    "啧，又去玩？怎么不带我。",
                    "旅行不带我？",
                    "反正只要和你在一起，去哪儿都可以。",
                    "啧，下次带我一起",
                    "笨兔子和小熊猫的足迹是越来越广了",
                    "啧，照片记得发我。"
                ],
                '话费网费': [
                    "啧，网络别断，我要视频",
                    "网络记得保持畅通，我要查岗"
                ],
                '学习': [
                    "啧，品学兼优这四个字懂吗？就是为我量身打造的。",
                    "学习别太累。",
                    "行，学习是好事。"
                ],
                '日用品': [
                    "啧，日用品又用完了？",
                    "买这么多怎么不叫我一起？在那等着，我来找你了。",
                   "下次我陪你去买",
                   "还差什么？列个单子给我。"
                ],
                '美妆': [
                    "看我干什么？经过你的特训我现在强的可怕。",
                    "啧，这个口红没有昨天那个好吃。"
               ],
                '医疗': [
                    "生病了？怎么不告诉我，我现在来找你。",
                    "我现在过去。",
                    "果然是只笨兔子。",
                    "病好了还是要跟我出去多锻炼锻炼。",
                    "你不舒服？我现在过去。"
                ],
                '娱乐': [
                    "啧，又去玩不叫我？",
                    "玩得挺开心啊，把我一个人丢家里。",
                    "去看live了？哪个乐队？有isolated好？",
                    "打游戏吗？",
                    "上线怎么不喊我？",
                    "这周日我在live house有演出，记得来看我。",
                    "不喊我一起？",
                    "下个假期，我先预定了。"
                ],
                '人情往来': [
                    "啧，又送礼？"
               ],
                '运动': [
                    "去运动了？真是难得。",
                    "不如陪我去滑滑板，保你能吃好睡好", 
                    "怎么不喊我一起？", 
                    "哟，太阳打西边出来了。",
                    "开门，我带了烧烤。", 
                    "减什么肥啊，你又不胖。"
               ],
                '水电煤': [
                   "嗯，知道了。"
                ],
                '其他': [
                    "啧，这是什么开销？",
                    "这又是什么？我？", 
                    "给你捏了个兔子。", 
                    "？解释一下。", 
                    "行吧, 我看看。", 
                    "嗯。"
                 ]
            }
        };

        // 创建雨滴效果
        function createRain() {
            const rainCount = 50;
            for (let i = 0; i < rainCount; i++) {
                const raindrop = document.createElement('div');
                raindrop.className = 'raindrop';
                
                // 随机位置
                const left = Math.random() * 100;
                const delay = Math.random() * 5;
                const duration = 1 + Math.random() * 2;
                
                raindrop.style.left = `${left}%`;
                raindrop.style.animationDelay = `${delay}s`;
                raindrop.style.animationDuration = `${duration}s`;
                
                rainContainer.appendChild(raindrop);
            }
        }

        // 初始化
        function init() {
            createRain();
            updateLedgerNames();
            renderRecords();
            updateBalance();
            setupEventListeners();
            avatar.src = currentAvatar;
        }

        // 更新账本名称
        function updateLedgerNames() {
            tabLove.textContent = ledgerName.love;
            tabDaily.textContent = ledgerName.daily;
            
            if (currentTab === 'love') {
                balanceTitle.textContent = '恋爱基金余额';
                incomeLabel.textContent = '存钱';
                expenseLabel.textContent = '花钱';
            } else {
                balanceTitle.textContent = '总消费';
                incomeLabel.textContent = '收入';
                expenseLabel.textContent = '支出';
            }
        }

        // 设置事件监听
        function setupEventListeners() {
            // 标签切换
            tabLove.addEventListener('click', () => switchTab('love'));
            tabDaily.addEventListener('click', () => switchTab('daily'));

            // 时间筛选
            timeFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    timeFilterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    renderRecords();
                });
            });

            // 添加记录
            addBtn.addEventListener('click', openRecordModal);
            closeModal.addEventListener('click', closeRecordModal);

            // 记录类型切换
            incomeRadio.addEventListener('change', updateCategoryOptions);
            expenseRadio.addEventListener('change', updateCategoryOptions);

            // 提交记录
            submitRecord.addEventListener('click', addRecord);

            // 头像相关
            avatar.addEventListener('click', openAvatarModal);
            closeAvatarModal.addEventListener('click', closeAvatarModalFunc);
            confirmAvatar.addEventListener('click', confirmAvatarFunc);

            // 头像选择
            Array.from(avatarOptions.children).forEach(option => {
                option.addEventListener('click', function() {
                    Array.from(avatarOptions.children).forEach(child => child.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // 头像上传
            avatarUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newAvatar = document.createElement('img');
                        newAvatar.className = 'avatar-option selected';
                        newAvatar.src = event.target.result;
                        newAvatar.dataset.src = event.target.result;
                        
                        // 移除之前的选择
                        Array.from(avatarOptions.children).forEach(child => child.classList.remove('selected'));
                        
                        // 添加新头像
                        avatarOptions.appendChild(newAvatar);
                        newAvatar.addEventListener('click', function() {
                            Array.from(avatarOptions.children).forEach(child => child.classList.remove('selected'));
                            this.classList.add('selected');
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 切换标签
        function switchTab(tab) {
            currentTab = tab;
            tabLove.classList.toggle('active', tab === 'love');
            tabDaily.classList.toggle('active', tab === 'daily');
            
            updateLedgerNames();
            updateBalance();
            renderRecords();
        }

        // 打开记录模态框
        function openRecordModal() {
            recordModal.style.display = 'flex';
            amountInput.value = '';
            noteTextarea.value = '';
            updateCategoryOptions();
        }

        // 关闭记录模态框
        function closeRecordModal() {
            recordModal.style.display = 'none';
        }

        // 更新分类选项
        function updateCategoryOptions() {
            categoryGrid.innerHTML = '';
            
            const type = incomeRadio.checked ? 'income' : 'expense';
            const currentCategories = type === 'income' ? categories.love : categories.daily;
            
            currentCategories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.textContent = category;
                item.dataset.category = category;
                item.addEventListener('click', function() {
                    Array.from(categoryGrid.children).forEach(child => child.classList.remove('selected'));
                    this.classList.add('selected');
                });
                categoryGrid.appendChild(item);
            });
            
            // 默认选择第一个
            if (categoryGrid.firstChild) {
                categoryGrid.firstChild.classList.add('selected');
            }
        }

        // 添加记录
        function addRecord() {
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效的金额');
                return;
            }

            const type = incomeRadio.checked ? 'income' : 'expense';
            const account = accountSelect.value;
            const note = noteTextarea.value.trim();
            
            const selectedCategory = document.querySelector('.category-item.selected');
            if (!selectedCategory) {
                alert('请选择分类');
                return;
            }
            const category = selectedCategory.dataset.category;

            // 生成小熊猫的评论
            let comment;
            if (currentTab === 'love' && type === 'income') {
                // 恋爱账本的存款
                comment = comments.deposit[Math.floor(Math.random() * comments.deposit.length)];
            } else if (currentTab === 'daily' && type === 'expense') {
                // 日常账本的支出
                const categoryComments = comments.daily[category] || comments.daily['其他'];
                comment = categoryComments[Math.floor(Math.random() * categoryComments.length)];
            } else {
                // 其他情况
                comment = "啧，记账了？";
            }

            const now = new Date();
            const record = {
                id: Date.now(),
                ledger: currentTab,
                type: type,
                amount: amount,
                account: account,
                category: category,
                note: note,
                comment: comment,
                timestamp: now.getTime(),
                date: now.toISOString()
            };

            records.push(record);
            saveRecords();
            renderRecords();
            updateBalance();
            closeRecordModal();
        }

        // 渲染记录列表
        function renderRecords() {
            const filteredRecords = records.filter(record => {
                // 按账本筛选
                if (record.ledger !== currentTab) return false;
                
                // 按时间筛选
                const recordDate = new Date(record.timestamp);
                const now = new Date();
                
                switch (currentPeriod) {
                    case 'week':
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        return recordDate >= startOfWeek;
                    case 'month':
                        return recordDate.getMonth() === now.getMonth() && 
                               recordDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return recordDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });

            if (filteredRecords.length === 0) {
                recordList.innerHTML = '<div class="empty-state">暂无记录，点击右下角按钮添加</div>';
                return;
            }

            // 按时间倒序排序
            filteredRecords.sort((a, b) => b.timestamp - a.timestamp);

            recordList.innerHTML = '';
            filteredRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                const dateStr = recordDate.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.dataset.id = record.id;
                
                let amountClass = record.type === 'income' ? 'income' : 'expense';
                let amountSign = record.type === 'income' ? '+' : '-';
                
                recordItem.innerHTML = `
                    <div class="record-header">
                        <span class="record-account">${record.account}</span>
                        <span class="record-amount ${amountClass}">${amountSign}¥${record.amount.toFixed(2)}</span>
                    </div>
                    <span class="record-category">${record.category}</span>
                    ${record.note ? `<div class="record-note">${record.note}</div>` : ''}
                    <div class="record-comment">
                        <div class="comment-name">${commentName} <span class="edit-name" data-id="${record.id}">✎</span></div>
                        ${record.comment}
                    </div>
                    <div class="record-time">${dateStr}</div>
                    <div class="delete-btn" data-id="${record.id}">×</div>
                `;
                
                recordList.appendChild(recordItem);
            });

            // 添加删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    deleteRecord(id);
                });
            });

            // 添加编辑评论名称事件
            document.querySelectorAll('.edit-name').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = parseInt(this.dataset.id);
                    const newName = prompt('修改评论者名称', commentName);
                    if (newName && newName.trim()) {
                        commentName = newName.trim();
                        localStorage.setItem('lingxiao-comment-name', commentName);
                        renderRecords();
                    }
                });
            });

            // 添加长按编辑账本名称事件
            [tabLove, tabDaily].forEach((tab, index) => {
                tab.addEventListener('longpress', function() {
                    const key = index === 0 ? 'love' : 'daily';
                    const newName = prompt('修改账本名称', ledgerName[key]);
                    if (newName && newName.trim()) {
                        ledgerName[key] = newName.trim();
                        localStorage.setItem(`lingxiao-ledger-name-${key}`, ledgerName[key]);
                        updateLedgerNames();
                    }
                });
            });

            // 模拟长按事件
            let pressTimer;
            [tabLove, tabDaily].forEach(tab => {
                tab.addEventListener('mousedown', function(e) {
                    pressTimer = window.setTimeout(function() {
                        tab.dispatchEvent(new Event('longpress'));
                    }, 1000);
                });
                
                tab.addEventListener('touchstart', function(e) {
                    pressTimer = window.setTimeout(function() {
                        tab.dispatchEvent(new Event('longpress'));
                    }, 1000);
                });
                
                tab.addEventListener('mouseup', function(e) {
                    clearTimeout(pressTimer);
                });
                
                tab.addEventListener('mouseleave', function(e) {
                    clearTimeout(pressTimer);
                });
                
                tab.addEventListener('touchend', function(e) {
                    clearTimeout(pressTimer);
                });
            });
        }

        // 删除记录
        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？')) {
                records = records.filter(record => record.id !== id);
                saveRecords();
                renderRecords();
                updateBalance();
            }
        }

        // 更新余额/总消费显示
        function updateBalance() {
            const filteredRecords = records.filter(record => record.ledger === currentTab);
            
            if (currentTab === 'love') {
                // 恋爱基金显示余额
                const income = filteredRecords
                    .filter(r => r.type === 'income')
                    .reduce((sum, r) => sum + r.amount, 0);
                const expense = filteredRecords
                    .filter(r => r.type === 'expense')
                    .reduce((sum, r) => sum + r.amount, 0);
                const balance = income - expense;
                balanceAmount.textContent = `¥${balance.toFixed(2)}`;
                
                // 根据余额变化背景色
                const hue = balance > 0 ? 280 : 350; // 紫色或粉红色
                const saturation = Math.min(100, Math.abs(balance) / 10 * 100);
                balanceCard.style.background = `linear-gradient(135deg, hsl(${hue}, ${saturation}%, 70%), var(--accent-color))`;
            } else {
                // 日常开销显示总支出
                const totalExpense = filteredRecords
                    .filter(r => r.type === 'expense')
                    .reduce((sum, r) => sum + r.amount, 0);
                balanceAmount.textContent = `¥${totalExpense.toFixed(2)}`;
                
                // 根据支出变化背景色
                const hue = 350; // 粉红色
                const saturation = Math.min(100, totalExpense / 1000 * 100);
                balanceCard.style.background = `linear-gradient(135deg, hsl(${hue}, ${saturation}%, 70%), var(--secondary-color))`;
            }
        }

        // 保存记录到本地存储
        function saveRecords() {
            localStorage.setItem('lingxiao-account-records', JSON.stringify(records));
        }

        // 打开头像选择模态框
        function openAvatarModal() {
            avatarModal.style.display = 'flex';
        }

        // 关闭头像选择模态框
        function closeAvatarModalFunc() {
            avatarModal.style.display = 'none';
        }

        // 确认头像选择
        function confirmAvatarFunc() {
            const selected = document.querySelector('.avatar-option.selected');
            if (selected) {
                currentAvatar = selected.dataset.src;
                avatar.src = currentAvatar;
                localStorage.setItem('lingxiao-avatar', currentAvatar);
                closeAvatarModalFunc();
            }
        }

        // 初始化应用
        init();
    </script>
</body>
</html>