<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笨兔子和小熊猫的恋爱记账本</title>
    <style>
        :root {
            --primary-color: #f8bbd0;
            --secondary-color: #bbdefb;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --light-text: #666;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --income-color: #4caf50;
            --expense-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .rain-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0.1;
        }

        .drop {
            position: absolute;
            width: 1px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(200, 200, 255, 0.8), rgba(200, 200, 255, 0.2));
            animation: rain linear infinite;
        }

        @keyframes rain {
            0% {
                transform: translateY(-100vh);
            }
            100% {
                transform: translateY(100vh);
            }
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
        }

        .avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--primary-color);
        }

        .avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            display: none;
        }

        .account-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .account-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .account-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .balance-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
            text-align: center;
        }

        .balance-title {
            font-size: 14px;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .balance-detail {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            color: var(--light-text);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .detail-value.income {
            color: var(--income-color);
        }

        .detail-value.expense {
            color: var(--expense-color);
        }

        .action-buttons {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .action-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .income-button {
            background-color: var(--primary-color);
            color: white;
        }

        .expense-button {
            background-color: var(--secondary-color);
            color: white;
        }

        .action-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .time-filter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filter-button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background-color: white;
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        .filter-button.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .records-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            margin-bottom: 20px;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-left {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .record-category {
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .category-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .record-account {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .record-comment {
            font-size: 13px;
            color: var(--light-text);
            font-style: italic;
            margin-top: 5px;
            padding: 5px 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }

        .record-comment-author {
            font-weight: bold;
            color: #e91e63;
        }

        .record-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .record-amount.income {
            color: var(--income-color);
            font-weight: bold;
        }

        .record-amount.expense {
            color: var(--expense-color);
            font-weight: bold;
        }

        .record-date {
            font-size: 12px;
            color: var(--light-text);
            margin-top: 5px;
        }

        .record-delete {
            color: var(--light-text);
            font-size: 12px;
            margin-top: 5px;
            cursor: pointer;
            text-decoration: underline;
        }

        .record-delete:hover {
            color: var(--expense-color);
        }

        .no-records {
            text-align: center;
            padding: 20px;
            color: var(--light-text);
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: var(--light-text);
        }

        .modal-title {
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--light-text);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
        }

        .form-radio-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .form-radio {
            display: none;
        }

        .form-radio-label {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-radio:checked + .form-radio-label {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .form-submit {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .category-tag {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-tag.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .avatar-modal-content {
            text-align: center;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: 15px auto;
            border: 3px solid var(--primary-color);
        }

        .avatar-upload-btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .settings-modal-content {
            text-align: center;
        }

        .settings-input {
            margin-bottom: 15px;
        }

        @media (max-width: 400px) {
            .container {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .time-filter {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .filter-button {
                flex: 1;
                min-width: 30%;
            }
        }
    </style>
</head>
<body>
    <div class="rain-background" id="rainBackground"></div>
    
    <div class="container">
        <div class="header">
            <div class="app-title" id="appTitle">笨兔子和小熊猫的恋爱记账本</div>
            <div class="avatar-container" id="avatarContainer">
                <img src="https://via.placeholder.com/40" alt="Avatar" class="avatar" id="avatar">
                <input type="file" id="avatarUpload" class="avatar-upload" accept="image/*">
            </div>
        </div>
        
        <div class="account-switcher">
            <div class="account-tab active" data-account="love">和凌肖的恋爱小荷包</div>
            <div class="account-tab" data-account="daily">日常开销</div>
        </div>
        
        <div class="balance-container">
            <div class="balance-title">当前余额</div>
            <div class="balance-amount" id="balanceAmount">¥0.00</div>
            <div class="balance-detail">
                <div class="detail-item">
                    <div class="detail-label">总收入</div>
                    <div class="detail-value income" id="totalIncome">¥0.00</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">总支出</div>
                    <div class="detail-value expense" id="totalExpense">¥0.00</div>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="action-button income-button" id="incomeButton">存钱</button>
            <button class="action-button expense-button" id="expenseButton">花钱</button>
        </div>
        
        <div class="time-filter">
            <button class="filter-button active" data-filter="all">全部</button>
            <button class="filter-button" data-filter="week">本周</button>
            <button class="filter-button" data-filter="month">本月</button>
            <button class="filter-button" data-filter="year">今年</button>
        </div>
        
        <div class="records-container" id="recordsContainer">
            <div class="no-records">暂无记录，点击上方按钮添加</div>
        </div>
    </div>
    
    <!-- 收入/支出模态框 -->
    <div class="modal" id="recordModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <div class="modal-title" id="modalTitle">添加记录</div>
            <form id="recordForm">
                <input type="hidden" id="recordId">
                <input type="hidden" id="recordType">
                
                <div class="form-group">
                    <label for="recordAmount" class="form-label">金额</label>
                    <input type="number" id="recordAmount" class="form-input" placeholder="输入金额" required>
                </div>
                
                <div class="form-group">
                    <label for="recordAccount" class="form-label">账户</label>
                    <select id="recordAccount" class="form-select" required>
                        <option value="">选择账户</option>
                        <option value="微信">微信</option>
                        <option value="支付宝">支付宝</option>
                        <option value="银行卡">银行卡</option>
                    </select>
                </div>
                
                <div class="form-group" id="categoryGroup">
                    <label class="form-label">分类</label>
                    <div class="category-tags" id="categoryTags">
                        <div class="category-tag" data-category="零食">零食</div>
                        <div class="category-tag" data-category="衣服">衣服</div>
                        <div class="category-tag" data-category="交通">交通</div>
                        <div class="category-tag" data-category="旅行">旅行</div>
                        <div class="category-tag" data-category="话费网费">话费网费</div>
                        <div class="category-tag" data-category="学习">学习</div>
                        <div class="category-tag" data-category="日用品">日用品</div>
                        <div class="category-tag" data-category="美妆">美妆</div>
                        <div class="category-tag" data-category="医疗">医疗</div>
                        <div class="category-tag" data-category="娱乐">娱乐</div>
                        <div class="category-tag" data-category="人情往来">人情往来</div>
                        <div class="category-tag" data-category="运动">运动</div>
                        <div class="category-tag" data-category="水电煤">水电煤</div>
                        <div class="category-tag" data-category="其他">其他</div>
                    </div>
                    <input type="hidden" id="recordCategory">
                </div>
                
                <div class="form-group">
                    <label for="recordNote" class="form-label">备注</label>
                    <input type="text" id="recordNote" class="form-input" placeholder="可选备注">
                </div>
                
                <button type="submit" class="form-submit">确认</button>
            </form>
        </div>
    </div>
    
    <!-- 头像模态框 -->
    <div class="modal" id="avatarModal">
        <div class="modal-content avatar-modal-content">
            <span class="modal-close" id="avatarModalClose">&times;</span>
            <div class="modal-title">我的头像</div>
            <img src="https://via.placeholder.com/150" alt="Avatar Preview" class="avatar-preview" id="avatarPreview">
            <label for="newAvatarUpload" class="avatar-upload-btn">更换头像</label>
            <input type="file" id="newAvatarUpload" class="avatar-upload" accept="image/*">
        </div>
    </div>
    
    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal-content">
            <span class="modal-close" id="settingsModalClose">&times;</span>
            <div class="modal-title">设置</div>
            
            <div class="form-group">
                <label for="userNickname" class="form-label">你的昵称</label>
                <input type="text" id="userNickname" class="form-input" placeholder="输入你的昵称">
            </div>
            
            <div class="form-group">
                <label for="partnerNickname" class="form-label">凌肖的昵称</label>
                <input type="text" id="partnerNickname" class="form-input" placeholder="输入凌肖的昵称">
            </div>
            
            <div class="form-group">
                <label for="loveAccountName" class="form-label">恋爱账本名称</label>
                <input type="text" id="loveAccountName" class="form-input" placeholder="输入恋爱账本名称">
            </div>
            
            <div class="form-group">
                <label for="dailyAccountName" class="form-label">日常账本名称</label>
                <input type="text" id="dailyAccountName" class="form-input" placeholder="输入日常账本名称">
            </div>
            
            <button class="form-submit" id="saveSettings">保存设置</button>
        </div>
    </div>
    
    <script>
        // 凌肖的留言
        const lingXiaoComments = {
            deposit: [
                "看来我们的旅游资金又增加了。",
                "存钱可以，别饿着肚子。",
                "又加班了？不如存点时间陪我。",
                "我们的未来基金+1",
                "去吃火锅怎么样？我现在去找你。",
                "要不要来live house看我演出？",
                "行，下次带你去吃好吃的。",
                "积少成多，这么着急干什么，我来找你了。",
                "笨兔子理财能力见长啊。",
                "啧，看来要准备个更大的存钱罐了。",
                "啧，别累着自己，晚上我去接你。",
                "可以啊，这么能干。",
                "livehouse第一排的位置给你留着呢，大制作人什么时候赏脸？",
                "假期想去哪儿玩？反正和你一起，去哪儿都可以。",
                "走，带你吃顿好的。"
            ],
            expense: {
                零食: [
                    "又背着我吃独食？",
                    "啧，怎么不带我一起？",
                    "独乐乐不如众乐乐，分我一点。",
                    "下次给我买零食就够了，adam他们不要。",
                    "就这么点？够你塞牙缝？",
                    "你是不是又背着我偷吃了？"
                ],
                衣服: [
                    "买新衣服了？怎么不带我去。",
                    "眼光不错，果然和我呆久了笨兔子的审美都提升了不少。",
                    "买这么多新衣服，什么时候和我出来逛逛？",
                    "情侣装啊，我考虑一下"
                ],
                交通: [
                    "去哪儿了？怎么不叫我一起？",
                    "啧，这么远？下次我送你。",
                    "Adam他们问你什么时候来live house",
                    "到家了？我来找你了。",
                    "下次滑滑板带你。"
                ],
                旅行: [
                    "怎么不带我？",
                    "玩得开心吗，笨兔子。",
                    "啧，照片发我看看。",
                    "下次我们一起去。",
                    "想我了没？"
                ],
                话费网费: [
                    "跟谁聊这么久？",
                    "知道了。"
                ],
                学习: [
                    "啧，品学兼优这四个字懂吗？就是专门形容我的。",
                    "啧，别读傻了。",
                    "行，学习是好事。",
                    "看不懂的来问我。"
                ],
                日用品: [
                    "买的什么？我看看。",
                    "嗯，这些是该买了。",
                    "还缺什么，列个单子给我。"
                ],
                美妆: [
                    "看我干什么？我现在可分得清口红色号了。",
                    "这是什么？",
                    "上次的那个口红比较好吃。",
                    "这些瓶瓶罐罐的看着就头晕。",
                    "让我看看买了什么新东西。"
                ],
                医疗: [
                    "生病了？怎么不告诉我。",
                    "啧，笨兔子，会不会照顾自己。",
                    "哪不舒服？我现在过去。",
                    "我现在过去。"
                ],
                娱乐: [
                    "去看live了？哪个乐队？",
                    "打游戏吗？一起。",
                    "上线怎么不喊我。",
                    "明天陪我去碗池滑两圈。",
                    "这周日live house的演出——你会来的吧。",
                    "下个假期，我先预定了。",
                    "不喊我一起？",
                    "他们技术哪有我高。"
                ],
                人情往来: [
                    "什么人情？",
                    "嗯，知道了。"
                ],
                运动: [
                    "去运动了？真是难得。",
                    "不如陪我去滑滑板，保你能吃好睡好",
                    "怎么不喊我一起？",
                    "哟，太阳打西边出来了。",
                    "开门，我带了烧烤。",
                    "减什么肥啊，你哪儿胖了？"
                ],
                水电煤: [
                    "生活费。",
                    "知道了。",
                    "嗯。"
                ],
                其他: [
                    "这又是什么？",
                    "给你捏了个兔子。",
                    "？解释一下。",
                    "行吧。",
                    "我看看。",
                    "嗯。"
                ]
            }
        };

        // 应用状态
        const state = {
            currentAccount: 'love',
            currentFilter: 'all',
            records: [],
            settings: {
                userNickname: '笨兔子',
                partnerNickname: '凌肖',
                loveAccountName: '和凌肖的恋爱小荷包',
                dailyAccountName: '日常开销',
                avatar: ''
            },
            usedComments: {
                deposit: [],
                expense: {}
            }
        };

        // 初始化已使用的评论
        Object.keys(lingXiaoComments.expense).forEach(category => {
            state.usedComments.expense[category] = [];
        });

        // DOM元素
        const elements = {
            appTitle: document.getElementById('appTitle'),
            avatarContainer: document.getElementById('avatarContainer'),
            avatar: document.getElementById('avatar'),
            avatarUpload: document.getElementById('avatarUpload'),
            accountTabs: document.querySelectorAll('.account-tab'),
            balanceAmount: document.getElementById('balanceAmount'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'),
            incomeButton: document.getElementById('incomeButton'),
            expenseButton: document.getElementById('expenseButton'),
            filterButtons: document.querySelectorAll('.filter-button'),
            recordsContainer: document.getElementById('recordsContainer'),
            recordModal: document.getElementById('recordModal'),
            modalClose: document.getElementById('modalClose'),
            modalTitle: document.getElementById('modalTitle'),
            recordForm: document.getElementById('recordForm'),
            recordId: document.getElementById('recordId'),
            recordType: document.getElementById('recordType'),
            recordAmount: document.getElementById('recordAmount'),
            recordAccount: document.getElementById('recordAccount'),
            categoryGroup: document.getElementById('categoryGroup'),
            categoryTags: document.getElementById('categoryTags'),
            recordCategory: document.getElementById('recordCategory'),
            recordNote: document.getElementById('recordNote'),
            avatarModal: document.getElementById('avatarModal'),
            avatarModalClose: document.getElementById('avatarModalClose'),
            avatarPreview: document.getElementById('avatarPreview'),
            newAvatarUpload: document.getElementById('newAvatarUpload'),
            settingsModal: document.getElementById('settingsModal'),
            settingsModalClose: document.getElementById('settingsModalClose'),
            userNickname: document.getElementById('userNickname'),
            partnerNickname: document.getElementById('partnerNickname'),
            loveAccountName: document.getElementById('loveAccountName'),
            dailyAccountName: document.getElementById('dailyAccountName'),
            saveSettings: document.getElementById('saveSettings')
        };

        // 初始化应用
        function initApp() {
            loadSettings();
            loadRecords();
            renderUI();
            createRain();
            setupEventListeners();
        }

        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('accountBookSettings');
            if (savedSettings) {
                state.settings = JSON.parse(savedSettings);
            }
            
            // 更新UI
            elements.userNickname.value = state.settings.userNickname;
            elements.partnerNickname.value = state.settings.partnerNickname;
            elements.loveAccountName.value = state.settings.loveAccountName;
            elements.dailyAccountName.value = state.settings.dailyAccountName;
            
            // 更新账本名称
            document.querySelector('.account-tab[data-account="love"]').textContent = state.settings.loveAccountName;
            document.querySelector('.account-tab[data-account="daily"]').textContent = state.settings.dailyAccountName;
            
            // 更新头像
            if (state.settings.avatar) {
                elements.avatar.src = state.settings.avatar;
                elements.avatarPreview.src = state.settings.avatar;
            }
        }

        // 保存设置
        function saveSettings() {
            state.settings.userNickname = elements.userNickname.value;
            state.settings.partnerNickname = elements.partnerNickname.value;
            state.settings.loveAccountName = elements.loveAccountName.value;
            state.settings.dailyAccountName = elements.dailyAccountName.value;
            
            localStorage.setItem('accountBookSettings', JSON.stringify(state.settings));
            
            // 更新UI
            document.querySelector('.account-tab[data-account="love"]').textContent = state.settings.loveAccountName;
            document.querySelector('.account-tab[data-account="daily"]').textContent = state.settings.dailyAccountName;
            
            closeModal('settingsModal');
        }

        // 加载记录
        function loadRecords() {
            const savedRecords = localStorage.getItem('accountBookRecords');
            if (savedRecords) {
                state.records = JSON.parse(savedRecords);
            }
        }

        // 保存记录
        function saveRecords() {
            localStorage.setItem('accountBookRecords', JSON.stringify(state.records));
        }

        // 创建下雨效果
        function createRain() {
            const rainContainer = document.getElementById('rainBackground');
            const dropCount = Math.floor(window.innerWidth / 10);
            
            for (let i = 0; i < dropCount; i++) {
                const drop = document.createElement('div');
                drop.className = 'drop';
                
                // 随机位置和动画延迟
                drop.style.left = `${Math.random() * 100}%`;
                drop.style.animationDelay = `${Math.random() * 2}s`;
                drop.style.animationDuration = `${0.5 + Math.random() * 1.5}s`;
                drop.style.height = `${10 + Math.random() * 20}px`;
                drop.style.opacity = `${0.1 + Math.random() * 0.3}`;
                
                rainContainer.appendChild(drop);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 账本切换
            elements.accountTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.accountTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    state.currentAccount = tab.dataset.account;
                    renderUI();
                });
            });
            
            // 时间筛选
            elements.filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    elements.filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    state.currentFilter = button.dataset.filter;
                    renderRecords();
                });
            });
            
            // 收入/支出按钮
            elements.incomeButton.addEventListener('click', () => openRecordModal('income'));
            elements.expenseButton.addEventListener('click', () => openRecordModal('expense'));
            
            // 模态框关闭
            elements.modalClose.addEventListener('click', () => closeModal('recordModal'));
            elements.avatarModalClose.addEventListener('click', () => closeModal('avatarModal'));
            elements.settingsModalClose.addEventListener('click', () => closeModal('settingsModal'));
            
            // 表单提交
            elements.recordForm.addEventListener('submit', handleRecordSubmit);
            
            // 分类标签选择
            const tags = elements.categoryTags.querySelectorAll('.category-tag');
            tags.forEach(tag => {
                tag.addEventListener('click', () => {
                    tags.forEach(t => t.classList.remove('selected'));
                    tag.classList.add('selected');
                    elements.recordCategory.value = tag.dataset.category;
                });
            });
            
            // 头像上传
            elements.avatarContainer.addEventListener('click', () => openModal('avatarModal'));
            elements.newAvatarUpload.addEventListener('change', handleAvatarUpload);
            
            // 设置保存
            elements.saveSettings.addEventListener('click', saveSettings);
            
            // 长按标题打开设置
            elements.appTitle.addEventListener('longpress', () => {
                openModal('settingsModal');
            });
            
            // 检测长按事件
            let pressTimer;
            elements.appTitle.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    openModal('settingsModal');
                }, 1000);
            });
            
            elements.appTitle.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            
            elements.appTitle.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
            
            // 触摸事件支持
            elements.appTitle.addEventListener('touchstart', () => {
                pressTimer = setTimeout(() => {
                    openModal('settingsModal');
                }, 1000);
            });
            
            elements.appTitle.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
        }

        // 打开模态框
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 打开记录模态框
        function openRecordModal(type) {
            elements.recordForm.reset();
            elements.recordId.value = '';
            
            if (type === 'income') {
                elements.modalTitle.textContent = '存钱';
                elements.categoryGroup.style.display = 'none';
                elements.recordType.value = 'income';
            } else {
                elements.modalTitle.textContent = '花钱';
                elements.categoryGroup.style.display = 'block';
                elements.recordType.value = 'expense';
                
                // 重置分类选择
                const tags = elements.categoryTags.querySelectorAll('.category-tag');
                tags.forEach(tag => tag.classList.remove('selected'));
                elements.recordCategory.value = '';
            }
            
            openModal('recordModal');
            elements.recordAmount.focus();
        }

        // 处理头像上传
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    state.settings.avatar = event.target.result;
                    elements.avatar.src = event.target.result;
                    elements.avatarPreview.src = event.target.result;
                    localStorage.setItem('accountBookSettings', JSON.stringify(state.settings));
                };
                reader.readAsDataURL(file);
            }
        }

        // 处理记录提交
        function handleRecordSubmit(e) {
            e.preventDefault();
            
            const amount = parseFloat(elements.recordAmount.value);
            if (isNaN(amount) || amount <= 0) {
                alert('请输入有效的金额');
                return;
            }
            
            const account = elements.recordAccount.value;
            if (!account) {
                alert('请选择账户');
                return;
            }
            
            const type = elements.recordType.value;
            const note = elements.recordNote.value;
            
            if (type === 'expense') {
                const category = elements.recordCategory.value;
                if (!category) {
                    alert('请选择分类');
                    return;
                }
                
                addRecord({
                    id: elements.recordId.value || Date.now().toString(),
                    type: 'expense',
                    account,
                    amount,
                    category,
                    note,
                    accountType: state.currentAccount,
                    date: new Date().toISOString()
                });
            } else {
                addRecord({
                    id: elements.recordId.value || Date.now().toString(),
                    type: 'income',
                    account,
                    amount,
                    note,
                    accountType: state.currentAccount,
                    date: new Date().toISOString()
                });
            }
            
            closeModal('recordModal');
        }

        // 添加记录
        function addRecord(record) {
            // 如果是编辑现有记录，先删除旧记录
            if (record.id && state.records.some(r => r.id === record.id)) {
                state.records = state.records.filter(r => r.id !== record.id);
            }
            
            // 添加凌肖的评论
            if (record.accountType === 'love') {
                if (record.type === 'income') {
                    record.comment = getRandomComment('deposit');
                } else {
                    record.comment = getRandomComment('expense', record.category, record.amount);
                }
            }
            
            state.records.unshift(record);
            saveRecords();
            renderUI();
        }

        // 获取随机评论
        function getRandomComment(type, category, amount) {
            let comments = [];
            let usedComments = [];
            
            if (type === 'deposit') {
                comments = lingXiaoComments.deposit;
                usedComments = state.usedComments.deposit;
            } else if (type === 'expense' && category) {
                comments = lingXiaoComments.expense[category] || [];
                usedComments = state.usedComments.expense[category] || [];
            }
            
            // 如果所有评论都已使用过，重置已使用列表
            if (usedComments.length >= comments.length) {
                if (type === 'deposit') {
                    state.usedComments.deposit = [];
                } else {
                    state.usedComments.expense[category] = [];
                }
                usedComments = [];
            }
            
            // 过滤掉已使用的评论
            const availableComments = comments.filter(comment => !usedComments.includes(comment));
            
            // 随机选择一个评论
            let selectedComment = availableComments[Math.floor(Math.random() * availableComments.length)];
            
            // 如果没有可用评论，随机选择一个
            if (!selectedComment && comments.length > 0) {
                selectedComment = comments[Math.floor(Math.random() * comments.length)];
            }
            
            // 添加金额相关的评论
            if (amount) {
                if (amount > 200) {
                    selectedComment += " 啧，买这么多，你这是把店搬空了？";
                } else if (amount < 10) {
                    selectedComment += " 蚊子腿也是肉。";
                }
            }
            
            // 记录已使用的评论
            if (selectedComment) {
                if (type === 'deposit') {
                    state.usedComments.deposit.push(selectedComment);
                } else {
                    state.usedComments.expense[category].push(selectedComment);
                }
            }
            
            return selectedComment || "";
        }

        // 删除记录
        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗？')) {
                state.records = state.records.filter(record => record.id !== id);
                saveRecords();
                renderUI();
            }
        }

        // 渲染UI
        function renderUI() {
            // 更新按钮文本
            if (state.currentAccount === 'love') {
                elements.incomeButton.textContent = '存钱';
                elements.expenseButton.textContent = '花钱';
            } else {
                elements.incomeButton.textContent = '收入';
                elements.expenseButton.textContent = '支出';
            }
            
            // 计算余额和总额
            const currentRecords = state.records.filter(record => record.accountType === state.currentAccount);
            const totalIncome = currentRecords
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const totalExpense = currentRecords
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            // 更新UI
            elements.balanceAmount.textContent = `¥${balance.toFixed(2)}`;
            elements.totalIncome.textContent = `¥${totalIncome.toFixed(2)}`;
            elements.totalExpense.textContent = `¥${totalExpense.toFixed(2)}`;
            
            // 渲染记录
            renderRecords();
        }

        // 渲染记录
        function renderRecords() {
            let filteredRecords = state.records.filter(record => record.accountType === state.currentAccount);
            
            // 应用时间筛选
            const now = new Date();
            switch (state.currentFilter) {
                case 'week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    filteredRecords = filteredRecords.filter(record => new Date(record.date) >= startOfWeek);
                    break;
                case 'month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredRecords = filteredRecords.filter(record => new Date(record.date) >= startOfMonth);
                    break;
                case 'year':
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    filteredRecords = filteredRecords.filter(record => new Date(record.date) >= startOfYear);
                    break;
            }
            
            // 清空容器
            elements.recordsContainer.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                elements.recordsContainer.innerHTML = '<div class="no-records">暂无记录，点击上方按钮添加</div>';
                return;
            }
            
            // 渲染记录
            filteredRecords.forEach(record => {
                const recordEl = document.createElement('div');
                recordEl.className = 'record-item';
                
                // 分类图标和颜色
                let categoryText = '';
                let iconBgColor = '#9e9e9e';
                
                if (record.type === 'income') {
                    categoryText = '存入';
                    iconBgColor = '#4caf50';
                } else {
                    categoryText = record.category;
                    // 为不同分类设置不同颜色
                    const categoryColors = {
                        零食: '#ff9800',
                        衣服: '#e91e63',
                        交通: '#2196f3',
                        旅行: '#009688',
                        话费网费: '#3f51b5',
                        学习: '#795548',
                        日用品: '#607d8b',
                        美妆: '#ff4081',
                        医疗: '#f44336',
                        娱乐: '#9c27b0',
                        人情往来: '#673ab7',
                        运动: '#4caf50',
                        水电煤: '#00bcd4',
                        其他: '#9e9e9e'
                    };
                    iconBgColor = categoryColors[record.category] || '#9e9e9e';
                }
                
                // 格式化日期
                const recordDate = new Date(record.date);
                const dateStr = recordDate.toLocaleDateString();
                const timeStr = recordDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // 构建记录HTML
                recordEl.innerHTML = `
                    <div class="record-left">
                        <div class="record-category">
                            <div class="category-icon" style="background-color: ${iconBgColor}">${categoryText.charAt(0)}</div>
                            ${categoryText}
                        </div>
                        <div class="record-account">${record.account}</div>
                        ${record.note ? `<div class="record-note">${record.note}</div>` : ''}
                        ${record.comment ? `<div class="record-comment"><span class="record-comment-author">${state.settings.partnerNickname}:</span> ${record.comment}</div>` : ''}
                    </div>
                    <div class="record-right">
                        <div class="record-amount ${record.type}">${record.type === 'income' ? '+' : '-'}¥${record.amount.toFixed(2)}</div>
                        <div class="record-date">${dateStr} ${timeStr}</div>
                        <div class="record-delete" data-id="${record.id}">删除</div>
                    </div>
                `;
                
                elements.recordsContainer.appendChild(recordEl);
            });
            
            // 添加删除事件监听器
            document.querySelectorAll('.record-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord(btn.dataset.id);
                });
            });
        }

        // 初始化应用
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>